import "../styles/atencion/dashboard-atencion.css";
import { useState, useRef, useEffect } from "react";

export default function DashboardAtencion({
  rut,
  nombre,
  edad,
  sexo,
  direccion,
  telefono,
  email,
  prevision,
  date,
  time,
  professional,

  atencion,
  diagnostico,
  receta,
  examenes,
  indicaciones,
  ordenKinesiologia,
  indicacionQuirurgica,

  onChangeAtencion,
  onChangeDiagnostico,
  onChangeReceta,
  onChangeExamenes,
  onChangeIndicaciones,
  onChangeOrdenKinesiologia,
  onChangeIndicacionQuirurgica,

  onDictado,
  dictando,
  puedeDictar,

  onOrdenarClinicamente,
  puedeOrdenar,

  onImprimir,
  onGuardar,
  onModificar,
  onCancelar
}) {
  const [activeTab, setActiveTab] = useState('atencion');
  const textareaRefs = useRef({});

  const autoResize = (e) => {
    const textarea = e.target;
    textarea.style.height = "auto";
    textarea.style.height = `${textarea.scrollHeight}px`;
  };

  const sections = {
    atencion: { 
      title: "Atenci√≥n Cl√≠nica", 
      content: atencion, 
      onChange: onChangeAtencion,
      rows: 8,
      print: null
    },
    diagnostico: { 
      title: "Diagn√≥stico", 
      content: diagnostico, 
      onChange: onChangeDiagnostico,
      rows: 4,
      print: null
    },
    receta: { 
      title: "Receta M√©dica", 
      content: receta, 
      onChange: onChangeReceta,
      rows: 6,
      print: "receta"
    },
    examenes: { 
      title: "Ex√°menes Complementarios", 
      content: examenes, 
      onChange: onChangeExamenes,
      rows: 4,
      print: "examenes"
    },
    indicaciones: { 
      title: "Indicaciones Generales", 
      content: indicaciones, 
      onChange: onChangeIndicaciones,
      rows: 5,
      print: "indicaciones"
    },
    kinesiologia: { 
      title: "Orden Kin√©sica", 
      content: ordenKinesiologia, 
      onChange: onChangeOrdenKinesiologia,
      rows: 5,
      print: "kinesiologia"
    },
    quirurgica: { 
      title: "Indicaci√≥n Quir√∫rgica", 
      content: indicacionQuirurgica, 
      onChange: onChangeIndicacionQuirurgica,
      rows: 5,
      print: "quirurgica"
    }
  };

  const handlePrint = (section) => {
    onImprimir?.(sections[section].print);
  };

  return (
    <div className="clinical-dashboard">
      
      {/* HEADER PROFESIONAL */}
      <header className="clinical-header">
        <div className="header-content">
          <div className="patient-card">
            <div className="patient-avatar">
              <div className="avatar-icon">üë§</div>
            </div>
            <div className="patient-info">
              <h1 className="patient-name">{nombre}</h1>
              <div className="patient-meta">
                <span className="meta-item"><strong>RUT:</strong> {rut}</span>
                <span className="meta-item"><strong>Edad:</strong> {edad}</span>
                <span className="meta-item"><strong>Sexo:</strong> {sexo}</span>
              </div>
            </div>
          </div>

          <div className="header-actions">
            <div className="action-group">
              <button
                className={`voice-btn ${dictando ? 'active' : ''}`}
                onClick={onDictado}
                disabled={!puedeDictar}
                title="Dictado por voz"
              >
                {dictando ? "‚èπÔ∏è" : "üé§"}
              </button>
              <button
                className="ai-btn"
                onClick={onOrdenarClinicamente}
                disabled={!puedeOrdenar}
                title="Ordenar cl√≠nicamente"
              >
                üß† AI
              </button>
            </div>
            <div className="header-meta">
              <div className="meta-row">
                <span><strong>Fecha:</strong> {date} {time}</span>
                <span><strong>Profesional:</strong> {professional}</span>
              </div>
              <div className="meta-row">
                <span><strong>Previsi√≥n:</strong> {prevision || "‚Äî"}</span>
                <span><strong>Tel:</strong> {telefono || "‚Äî"}</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <main className="clinical-main">
        
        {/* TABS NAVIGATION */}
        <nav className="clinical-tabs">
          {Object.entries(sections).map(([key, section]) => (
            <button
              key={key}
              className={`tab-btn ${activeTab === key ? 'active' : ''}`}
              onClick={() => setActiveTab(key)}
            >
              {section.title.split(' ')[0]}
            </button>
          ))}
        </nav>

        {/* ACTIVE SECTION */}
        <section className="clinical-section">
          <div className="section-header">
            <h2>{sections[activeTab].title}</h2>
            {sections[activeTab].print && (
              <button
                className="print-btn"
                onClick={() => handlePrint(activeTab)}
                title="Imprimir"
              >
                üñ®Ô∏è
              </button>
            )}
          </div>
          
          <div className="editor-container">
            <textarea
              ref={(el) => { if (el) textareaRefs.current[activeTab] = el; }}
              className="clinical-editor"
              value={sections[activeTab].content}
              rows={sections[activeTab].rows}
              onChange={(e) => sections[activeTab].onChange(e.target.value)}
              onInput={autoResize}
              placeholder={`Escriba aqu√≠ las ${sections[activeTab].title.toLowerCase()}...`}
            />
          </div>
        </section>

        {/* CONTACT INFO SIDEBAR */}
        <aside className="patient-sidebar">
          <div className="sidebar-card">
            <h3>üìç Contacto</h3>
            <div className="contact-item">
              <span className="icon">üì±</span>
              <span>{telefono || "No registrado"}</span>
            </div>
            <div className="contact-item">
              <span className="icon">‚úâÔ∏è</span>
              <span>{email || "No registrado"}</span>
            </div>
            <div className="contact-item">
              <span className="icon">üè†</span>
              <span>{direccion || "No registrado"}</span>
            </div>
          </div>
        </aside>

      </main>

      {/* ACTION BAR */}
      <footer className="clinical-footer">
        <div className="footer-actions">
          {onCancelar && (
            <button className="btn-cancel" onClick={onCancelar}>
              Cancelar
            </button>
          )}
          {onModificar && (
            <button className="btn-secondary" onClick={onModificar}>
              Modificar
            </button>
          )}
          {onGuardar && (
            <button className="btn-primary" onClick={onGuardar}>
              üíæ Guardar Atenci√≥n
            </button>
          )}
        </div>
      </footer>

    </div>
  );
}
